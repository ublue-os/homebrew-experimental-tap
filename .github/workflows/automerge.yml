name: Automerge

on:
  workflow_run:
    workflows: ["Homebrew Bump"]
    types:
      - completed
  workflow_dispatch:

jobs:
  dispatch-tests:
    runs-on: ubuntu-latest
    if: >
      ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Dispatch CI for Bump PRs
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // Find open PRs by bump users
            // You can adjust the query as per your needs, e.g., filter by labels if added
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              per_page: 50
            });

            for (const pr of pulls) {
              const isBumpBot = ['lambdaclan', 'app/github-actions'].includes(pr.user.login);
              const isBumpBranch = pr.head.ref.startsWith('bump-');

              if ((isBumpBot || isBumpBranch) && !pr.draft) {
                console.log(`Dispatching Bump CI for PR #${pr.number}`);
                
                await github.rest.actions.createWorkflowDispatch({
                  owner,
                  repo,
                  workflow_id: 'bump-ci.yml',
                  ref: 'main', 
                  inputs: {
                    pr_number: pr.number.toString()
                  }
                });
              }
            }
